
# Face Encoding Service

This is a service for handling face encoding operations. It provides 
functionalities to start sessions, upload images, and perform face 
encoding on the uploaded images.

## Environment Setup

### Requirements

Python >= 3.12
Poetry >= 1.8.2
Docker

### Instalation

To install the dependencies and set up the project, follow these steps:

1. Clone the repository:

```shell
git clone https://github.com/your-username/face-encoding-service.git
```

2. Navigate to the project directory:

```shell
cd face-encoding-service
```

3. Install dependencies using Poetry:

```shell
poetry install
```

4. Install pre-commit (to run code checks at every commit)

```shell
pre-commit install
```

### Running the App

#### Docker Containers

This project contains a docker environment with four services:

1. `production_db` - A Postgres database to emulate a production base. 
It can also be used for manual tests. On your host, this instance
will be listening to connections on the port 5432.
2. `integration_tests_db` - Separate instance of a Postgres database 
which is used by Integration and E2E tests.
3. `veriff_face_encoding` - Image encoder service listening to requests
in the port 8000 of your host.
4. `face-encoding-backend` - This is the app itself, listening to requests
in the port 8001 of your host.

In order to spin up these services, you must have a local file `.env`
with the environment variables that our environment requires.

You can find an example of this file in `.env.example` which shows
options for running in "production" mode or for tests.

#### Running app as a Docker container

If you want to run the app in the docker container, just run:

```shell
docker-compose up --build -d
```

Your app will be listening to requests in http://localhost:8001. 

#### Running app from the code

If you'd like to run the application from the code, you will need
run the database that you'd like to use and Veriff's image encoder
service.

And then run your python app.

If you want to point to your production database, for instance, these
are the steps.

1. Spin up required containers

```shell
docker-compose up -d production_db veriff_face_encoding
```

2. Run the app with the required environment variables

```shell
poetry run env JWT_ENCODING_SECRET_KEY=<JWT ENCODING KEY> POSTGRES_ROOT_PASSWORD=<DATABASE_PASSWORD> python src/main.py
```

For these two environment variables, it is important that you pass the 
same values defined in your `.env` file.

Your app will also be listening to requests in http://localhost:8001. 

### Running the Automated tests

In order to run the automated tests, you will need to spin up the docker
environment using a set of specific values for your environment variables.

1. Make sure your `.env` file should have the following values:

```dotenv
POSTGRES_PORT=5432
JWT_ENCODING_SECRET_KEY=<JWT Encoding secret key>

# Integration Tests Database
POSTGRES_ROOT_PASSWORD=integration-tests
POSTGRES_HOST=integration_tests_db
POSTGRES_DB_NAME=face-encoding-it
FACE_ENCODING_SERVICE_HOST=veriff_face_encoding
```

2. Spin up Docker environment with the following command:

```shell
docker-compose up --build -d
```

3. Run the tests with
```shell
poetry run pytest
```

### Project Structure

The project follows the MVC (Model-View-Controller) architecture and is organized as follows:

- `src`: Contains the production code of the application.
  - `controllers/`: Controllers for handling HTTP requests and responses.
  - `exceptions/`: App's custom exceptions.
  - `models/`: SQLAlchemy models representing database tables.
  - `repositories/`: Data access layer for interacting with data sources.
  - `schemas/`: Pydantic models representing request and response schemas.
  - `services/`: Business logic layer for handling application logic.
  - `app.py`: FastAPI app definition
  - `db.py`: Database configuration/setup.
  - `main.py`: Entrypoint of the application.
  - `router.py`: Defines API routes using FastAPI's Router.
- `tests/`: Contains unit tests, integration tests, and end-to-end tests.
  - `e2e_tests/`: End-to-end tests for testing entire service functionality.
  - `fixtures/`: Sample image to be used in automated tests.
  - `integration_tests/`: Integration tests for repositories.
  - `unit_tests/`: Unit tests for controllers and services.
- `.env.example`: Example of `.env` file, which is required for Docker setup.
- `.flake8`: Flake8 linter configuration file.
- `.pre-commit-config.yaml`: Pre-commit webhooks configuration.
- `docker-compose.yml`: Docker Compose file for defining service dependencies and environment.
- `Dockerfile`: Dockerfile for building the Docker image.
- `poetry.lock`: Lock file generated by Poetry.
- `pyproject.toml`: Project metadata and dependencies specified in Poetry format.
